<!-- Webinar Room Page -->
<div class="webinar-room-container">
  <!-- Loading State -->
  <div ng-if="isLoading" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
      <p class="text-slate-300">Loading webinar room...</p>
    </div>
  </div>

  <!-- Webinar Room Content -->
  <div ng-if="!isLoading" class="webinar-room-content">

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden main-content" ng-class="{'chat-hidden': chatHidden}">
      
      <!-- Video Area -->
      <div class="flex-1 flex flex-col bg-black video-area desktop-video-container">
        
  <!-- Waiting State -->
  <div ng-if="roomState.status === 'waiting'" class="flex-1 flex items-center justify-center py-10 md:py-16">
          <div class="text-center text-white">
            <div class="mb-6">
              <i class="fas fa-clock text-4xl text-primary-500 mb-4"></i>
              <h2 class="text-2xl font-bold mb-2">Webinar Starts Soon</h2>
              <p class="text-slate-300 mb-4">{{webinar.title}}</p>
            </div>
            
            <div class="bg-slate-800 rounded-lg p-3 max-w-md mx-auto">
              <div class="text-3xl font-mono mb-2">{{formatTimeToStart()}}</div>
              <p class="text-slate-400 text-sm">Time remaining</p>
            </div>
            
            <div class="mt-6 text-slate-400">
              <p>Hosted by: {{webinar.hostName || 'Host'}}</p>
              <p>Duration: {{webinar.duration}} minutes</p>
            </div>
          </div>
        </div>
        
    <!-- Live Video Container (only render video when LIVE) -->
  <div class="flex-1 relative video-container" style="width: 100%; height: 100%; overflow: hidden;" ng-class="{'opacity-0 pointer-events-none': roomState.status === 'waiting'}">
          
          <!-- Test Video - Simple HTML5 Video -->
          <div style="width: 100%; height: 100%; background: #000; position: relative;">
            <video 
              id="webinarVideo" 
              preload="auto"
              playsinline
              webkit-playsinline
              disablepictureinpicture
              controlslist="nodownload noplaybackrate noremoteplayback nofullscreen"
              x-webkit-airplay="deny"
              muted
              autoplay="false"
              style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; object-fit: contain; object-position: center center; background: #000; display: block; min-width: 1px; min-height: 1px;"
              ng-if="roomState.status === 'live'"
              ng-src="{{videoUrl || getVideoUrl()}}"
              onerror="angular.element(this).scope().onVideoError()"
              onloadeddata="angular.element(this).scope().onVideoLoad()"
              onloadstart="angular.element(this).scope().onVideoLoad()"
              oncanplay="console.log('üì± Video can play, readyState:', this.readyState, 'src:', this.src)"
              oncanplaythrough="console.log('üì± Video can play through')"
              onended="angular.element(this).scope().onVideoEnded()">
              Your browser does not support the video tag.
            </video>
          </div>
          
          <!-- Resume Overlay (shows after refresh) -->
          <div ng-if="showResumeButton" class="resume-overlay">
            <button ng-click="resumeVideo()" class="resume-btn bg-primary-600 hover:bg-primary-700 text-white px-8 py-4 rounded-full flex items-center space-x-3 text-xl font-semibold shadow-lg transition-all transform hover:scale-105">
              <i class="fas fa-play text-2xl"></i>
              <span>Let's Go</span>
            </button>
          </div>
          
          <!-- Video Controls Overlay (Host Only) -->
          <div ng-if="isVideoLoaded && isHost" class="absolute bottom-4 left-4 flex space-x-2 video-controls">
            <button ng-click="playVideo()" 
                    class="control-button">
              <i class="fas fa-play"></i>
            </button>
            <button ng-click="pauseVideo()" 
                    class="control-button">
              <i class="fas fa-pause"></i>
            </button>
          </div>
          
        </div>
        
        <!-- Ended State -->
        <div ng-if="roomState.status === 'ended'" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center">
          <div class="text-center text-white">
            <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">Webinar Ended</h2>
            <p class="text-slate-300 mb-4">Thank you for attending!</p>
            <button ng-click="leaveRoom()" 
                    class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors">
              Exit Room
            </button>
          </div>
        </div>
        
      </div>

      <!-- Bottom Control Panel - Below Video -->
      <div class="control-panel-redesign">
        <span class="live-badge">‚óè LIVE</span>
        
        <button ng-click="!micEnabled || toggleMicrophone()" 
                class="ctrl-btn" 
                ng-class="{'muted': !micEnabled}"
                ng-disabled="!micEnabled">
          <i class="fas" ng-class="{'fa-microphone': micEnabled, 'fa-microphone-slash': !micEnabled}"></i>
        </button>
        
        <button ng-click="!videoEnabled || toggleVideo()" 
                class="ctrl-btn" 
                ng-class="{'off': !videoEnabled}"
                ng-disabled="!videoEnabled">
          <i class="fas" ng-class="{'fa-video': videoEnabled, 'fa-video-slash': !videoEnabled}"></i>
        </button>
        
        <button class="ctrl-btn chat-btn" 
                ng-class="{'active': !chatHidden}"
                ng-click="toggleChat()">
          <i class="fas fa-comment"></i>
        </button>
        
        <button ng-click="leaveRoom()" class="ctrl-btn leave-btn">
          <i class="fas fa-phone-slash"></i>
        </button>
        
        <span class="participant-count" ng-hide="roomState.status === 'waiting'">
          <i class="fa fa-users"></i> {{attendeeCount || 1}}
        </span>
      </div>

      <!-- Enhanced Chat Panel -->
      <div class="chat-panel" ng-class="{'hidden': chatHidden}">
        
        <!-- Chat Header -->
        <div class="px-3 py-2 border-b border-slate-700 chat-header flex items-center justify-between">
          <h3 class="font-semibold text-white">Chat</h3>
          <p class="text-sm text-slate-400">{{chatMessages.length}} messages</p>
        </div>
        
        <!-- Chat Messages -->
        <div id="chatContainer" class="overflow-y-auto p-4 space-y-3 chat-messages">
          <div ng-repeat="message in chatMessages" class="animate-fade-in">            <!-- System Message -->
            <div ng-if="message.isSystem" class="text-center">
              <div class="bg-slate-700 text-slate-300 text-sm px-3 py-2 rounded-lg inline-block">
                {{message.message}}
              </div>
            </div>
            
            <!-- User Message -->
            <div ng-if="!message.isSystem" class="bg-blue-900 rounded-lg p-3">
              <div class="flex items-start space-x-2">
                <div class="w-8 h-8 bg-primary-600 rounded-full flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-xs font-bold">{{message.sender.charAt(0)}}</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center space-x-2 mb-1">
                    <span class="font-medium text-white text-sm">{{message.sender}}</span>
                    <span class="text-slate-400 text-xs">{{message.timestamp | date:'HH:mm'}}</span>
                  </div>
                  <!-- Text message -->
                  <p ng-if="!message.type || message.type === 'text'" class="text-slate-300 text-sm break-words">{{message.message}}</p>
                  
                  <!-- CTA message with buttons -->
                  <div ng-if="message.type === 'cta'" class="space-y-2">
                    <p class="text-slate-300 text-sm break-words">{{message.message}}</p>
                    <div class="flex flex-wrap gap-2">
                      <a ng-repeat="btn in message.buttons" ng-href="{{btn.url}}" target="_blank" rel="noopener"
                         class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-xs font-semibold">
                        {{btn.label}}
                      </a>
                    </div>
                  </div>
                  
                  <!-- Image message -->
                  <div ng-if="message.type === 'image'" class="space-y-2">
                    <img ng-src="{{message.imageUrl}}" alt="scheduled image" class="rounded-md max-h-48 object-contain" />
                    <p ng-if="message.message" class="text-slate-300 text-sm break-words">{{message.message}}</p>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
        
        <!-- Chat Input -->
        <div ng-if="isWebinarLive" class="p-4 border-t border-slate-700 chat-input">
          <!-- To Host Indicator -->          <div class="flex space-x-2">
            <input type="text" 
                   ng-model="chat.newMessage" 
                   ng-keypress="$event.keyCode == 13 && sendMessage()"
                   placeholder="Send a message to Host..."
                   class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm">
            <button ng-click="sendMessage()" 
                    ng-disabled="!chat.newMessage || chat.newMessage.trim() === ''"
                    class="px-4 py-2 bg-primary-600 hover:bg-primary-700 disabled:bg-slate-600 text-white rounded-lg transition-colors min-w-[44px] flex items-center justify-center text-sm font-bold">
              <i class="fas fa-paper-plane"></i>
              <span class="ml-1 hidden sm:inline landscape-hidden">Send</span>
            </button>
          </div>
        </div>
        
        <!-- Chat Disabled Message -->
        <div ng-if="!isWebinarLive" class="p-4 border-t border-slate-700 chat-disabled">
          <p class="text-slate-400 text-sm text-center">
            Chat will be available when the webinar starts
          </p>
        </div>
        
      </div>
      
    </div>
    
  </div>
  
</div>

<!-- Host Control Panel (only for hosts) -->
<div ng-if="isHost" ng-include="'/views/components/host-control-panel.html'"></div>

<!-- Lightweight Scheduler Modal for Hosts -->
<div ng-if="isHost && scheduler.open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
  <div class="bg-slate-900 border border-slate-700 rounded-lg w-full max-w-2xl shadow-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-white font-semibold">Automated Messages Scheduler</h3>
      <button class="text-slate-300 hover:text-white" ng-click="closeScheduler()">‚úï</button>
    </div>
    <div class="mb-3 text-slate-300 text-sm">Pause video at the desired time and add a message. Messages will appear to attendees only after the scheduled date/time has started.</div>
    <div class="flex gap-2 mb-4">
      <button class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded" ng-click="addScheduledTextAtNow()">+ Text at current time</button>
      <button class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded" ng-click="addScheduledCTAAtNow()">+ CTA at current time</button>
      <button class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded" ng-click="addScheduledImageAtNow()">+ Image at current time</button>
    </div>
    <div class="max-h-64 overflow-y-auto divide-y divide-slate-800">
      <div class="py-3" ng-repeat="m in scheduler.editing track by m.id">
        <div class="grid grid-cols-12 gap-2 items-start">
          <div class="col-span-2">
            <label class="block text-xs text-slate-400">Type</label>
            <select class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-700" ng-model="m.kind">
              <option value="text">Text</option>
              <option value="cta">CTA</option>
              <option value="image">Image</option>
            </select>
          </div>
          <div class="col-span-2">
            <label class="block text-xs text-slate-400">At (sec)</label>
            <input type="number" min="0" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-700" ng-model="m.atSeconds" />
          </div>
          <div class="col-span-7" ng-switch="m.kind">
            <div ng-switch-when="text">
              <label class="block text-xs text-slate-400">Message</label>
              <input class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-700" ng-model="m.text" placeholder="Type message..." />
            </div>
            <div ng-switch-when="cta">
              <label class="block text-xs text-slate-400">Text</label>
              <input class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-700 mb-2" ng-model="m.text" placeholder="CTA text..." />
              <div class="grid grid-cols-2 gap-2" ng-repeat="b in m.buttons">
                <input class="bg-slate-800 text-white text-xs p-2 rounded border border-slate-700" ng-model="b.label" placeholder="Button label" />
                <input class="bg-slate-800 text-white text-xs p-2 rounded border border-slate-700" ng-model="b.url" placeholder="Button URL" />
              </div>
              <button class="mt-2 px-2 py-1 bg-slate-700 text-white rounded text-xs" ng-click="m.buttons = (m.buttons||[]); m.buttons.push({label:'Buy now', url:'https://example.com'})">+ Add Button</button>
            </div>
            <div ng-switch-when="image">
              <label class="block text-xs text-slate-400">Image URL</label>
              <input class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-700 mb-2" ng-model="m.imageUrl" placeholder="https://..." />
              <label class="block text-xs text-slate-400">Caption</label>
              <input class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-700" ng-model="m.caption" placeholder="Optional caption..." />
            </div>
          </div>
          <div class="col-span-1 flex justify-end">
            <button class="text-red-400 hover:text-red-300" title="Remove" ng-click="removeScheduled(m.id)">‚úï</button>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-4 flex justify-end gap-2">
      <button class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded" ng-click="closeScheduler()">Cancel</button>
      <button class="px-3 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded disabled:opacity-60" ng-disabled="scheduler.saving" ng-click="saveScheduledMessages()">Save</button>
    </div>
  </div>
  
</div>

<!-- Scheduler open button for hosts -->
<div ng-if="isHost && !scheduler.open" class="fixed bottom-24 right-4 z-40">
  <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow" ng-click="openScheduler()">üïí Schedule Messages</button>
  <div class="mt-2 text-xs text-slate-300">Pause video to pick a time, then add.</div>
</div>

<!-- Styles moved to public/css/main.css to avoid inline <style> and improve cache busting -->
